@model List<Eureka_Forbes.Models.ProductMaster.ProductViewModel>
@{
    ViewData["Title"] = "Product Models & Steps";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center mt-3">Product Models & Steps</h2>
<div class="text-end mb-4">
    <a href="/ProductMaster/CreateProductMaster" class="btn btn-primary">Create New Product</a>
</div>

<div class="container mt-4">
    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Product Name</th>
                    <th>Model Names</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in Model)
                {
                    <tr>
                        <td><strong>@product.ProductName</strong></td>
                        <td>
                            <ul>
                                @foreach (var models in product.Models)
                                {
                                    <li>@models.ModelName</li>
                                }
                            </ul>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2" onclick="editProduct(@product.ProductId)">Edit</button>
                            <button class="btn btn-sm btn-info me-2" onclick="toggleDetails(@product.ProductId)">Details</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(@product.ProductId)">Delete</button>
                        </td>
                    </tr>
                    <tr id="details-@product.ProductId" class="details-row" style="display: none;">
                        <td colspan="3">
                            <div>
                                <h5>Steps for @product.ProductName</h5>
                                @foreach (var models in product.Models)
                                {
                                    <h6>Model: @models.ModelName</h6>
                                    @if (models.Steps.Any())
                                    {
                                        <table class="table table-bordered mt-2">
                                            <thead style="color: black; background-color: lightgray;">
                                                <tr>
                                                    <th>Priority</th>
                                                    <th>Step Name</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var step in models.Steps.OrderBy(s => s.Priority))
                                                {
                                                    <tr>
                                                        <td>@step.Priority</td>
                                                        <td>@step.StepName</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    }
                                    else
                                    {
                                        <p class="text-muted">No steps assigned.</p>
                                    }
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-center text-danger">No Products Found.</p>
    }
</div>

<script>
    function toggleDetails(productId) {
        var detailsRow = document.getElementById("details-" + productId);
        if (detailsRow.style.display === "none") {
            detailsRow.style.display = "table-row";
        } else {
            detailsRow.style.display = "none";
        }
    }

    function deleteProduct(productId) {
        if (confirm("All models and steps associated with the product will be deleted. Do you wish to continue?")) {
            fetch('/ProductMaster/DeleteProduct?productId=' + productId, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Product deleted successfully.");
                    window.location.reload();
                } else {
                    alert("Error deleting product: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while deleting the product.");
            });
        }
    }

    function editProduct(productId) {
        window.location.href = '/ProductMaster/UpdateProductMaster?productId=' + productId;
    }
</script>
